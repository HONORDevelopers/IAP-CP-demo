# 荣耀应用内支付服务客户端示例代码

本章节主要介绍接入荣耀应用内支付的客户端开发步骤，帮助您快速了解荣耀支付提供的客户端接口及其使用方法。

点击[此处](https://developer.hihonor.com/cn/doc/guides/101034)了解更多。


## 目录
  - [简介](#简介)
  - [开发准备](#开发准备)
  - [环境要求](#环境要求)
  - [IAP SDK集成](#IAP SDK集成)
  - [运行结果](#运行结果)
    - [获取商品信息](#获取商品信息)
    - [查询用户已购买商品](#查询用户已购买商品)
    - [购买PMS商品](#购买PMS商品)
    - [自定义商品购买](#自定义商品购买)
    - [取消订阅](#取消订阅)
    - [查看用户历史购买记录](#查看用户历史购买记录)

## 简介

荣耀应用内支付（In-App Purchases，即 IAP）是一种为 APP 提供支付能力的服务，拥有简洁的接入流程，让应用内支付更加便捷。应用可以通过集成荣耀 IAP SDK，调用其中的接口运行 IAP 的收银台，实现并完成应用内支付。

您可以使用应用内支付服务，在 APP 内销售以下类型的数字商品和内容：

- 一次性商品：指用户通过一次性付款（非定期付费）的方式购买的商品，包括消耗型商品和非消耗型商品。
  1. 消耗型商品：指使用一次后便被消耗，随使用而减少，需要再次购买的商品，可购买多次。例如：游戏货币，可重复购买的游戏道具等。
  2. 非消耗型商品：指购买一次就能永久使用的商品。例如：游戏中的解锁关卡礼包、应用中无时限的高级会员或购买一次即永久使用的应用主题等。
- 订阅型商品：指用户购买后在商品声明的时间段内允许使用的增值功能或内容，周期结束后自动续期购买下一期的服务，可以在同一个应用中提供多项订阅。例：应用中有时限的高级会员，如视频月度会员、云端存储应用的扩容空间订阅等。

## 开发准备

1. 检查Android Studio开发环境是否准备就绪。
2. 在荣耀开发者服务平台-管理中心中添加商品信息。详情请参见：[配置PMS商品](https://developer.hihonor.com/cn/doc/guides/101042)。
3. 在Android Studio中导入demo，再进行构建。
5. 配置示例代码：

   * 修改示例工程中应用级build.gradle文件中的applicationId为您自己的应用包名。
   * 修改示例工程中应用级build.gradle文件中的buildConfigField的PUBLIC_KEY为您自己应用的公钥，[获取公钥](https://developer.hihonor.com/cn/doc/guides/101041#h1-1671529392770)。
   * 修改示例工程中MainActivity中的appId、cpId为您自己的应用，[获取appId、cpId](https://developer.hihonor.com/cn/doc/guides/101035#h2-1689753152769)。
   * 将本demo中的商品替换为你的商品。
6. 在荣耀设备上运行该示例代码。

## 环境要求
* [JDK](https://www.oracle.com/java/technologies/javase-downloads.html) 1.8及以上版本
* 安装Android Studio3.6.1及以上版本
* 测试应用的设备：Magic UI 4.0及以上的荣耀手机（海外市场接入需使用海外荣耀机）

## IAP SDK集成

荣耀应用内支付提供了两种集成方式（本demo以在线Maven方式为例）：

* [本地 Maven 依赖方式](https://developer.hihonor.com/cn/doc/guides/101044#h1-1690265749191)。

  可以将 Demo 工程中名称为 ProjectMaven 拷贝到你的工程目录下，配置为本地 Maven 库，如下:

  ```markup
  repositories {
       maven {
           url uri("${rootDir}/ProjectMaven")
       }
       ……
   }
  ```

* [在线 Maven 依赖方式](https://developer.hihonor.com/cn/doc/guides/101044#h1-1690265784200)。

  可以在Android Studio 的代码库配置在 Gradle 插件7.0以下版本、7.0版本和7.1及以上版本有所不同。请根据您当前的 Gradle 插件版本，选择对应的配置过程。

## 运行结果

Demo运行后，会出现如下页面。

![](../images/homepage.png)

### 获取商品信息

若您的应用包含PMS商品，则需要在荣耀HONOR Developers平台上完成商品的配置。商品配置完成后，您可以调用SDK中的getProductInfo接口查下商品信息。

点击**获取商品信息（PMS）**，可以查看到在荣耀HONOR Developers平台上配置的商品信息。

### 查询用户已购买商品

在创建订单前，建议调用SDK的obtainOwnedPurchases接口查询已购买未消耗的商品，然后对未消耗的商品进行消耗。如果消耗商品放在服务端的话，可以把查询到的数据传到服务端然后消耗。此接口还可以查询非消耗型商品返回所有已购买的商品、订阅型商品只返回正在生效的商品。

点击**查询用户已购买商品**，可以查看到：

1、消耗型商品只返回用户已购买但未被消耗的商品。
2、非消耗型商品返回所有已购买的商品。
3、订阅型商品只返回正在生效的商品。

对于消耗型商品的已购买但未消耗的订单列表，需要走[补单流程](https://developer.hihonor.com/cn/doc/guides/101045#h2-1689845309219)，并在发货后可以选择在客户端对其消耗。

### 购买PMS商品

PMS商品指在荣耀HONOR Developers平台上配置的商品，包含消耗型、非消耗型和订阅型商品。您的应用可通过调用createProductOrderIntent接口发起消耗型商品的购买请求。

1. 点击**购买PMS商品**，需要设置商品类型、商品id、是否沙盒支付。

2. 如果不设置沙盒支付，显示微信、支付宝支付。

3. 如果设置沙盒支付，显示沙盒支付。

4. 点击**确认支付**，跳转相应的支付渠道，确认支付成功。

5. 点击**知道了**，返回到商品界面。如果购买的是消耗型商品，可以根据需求是否在客户端消耗。


### 自定义商品购买

自定义商品是根据业务需求，自定义商品名称（不能为空，不能包含符号＄、<、>，最长55个字 符。）、商品id等信息，不需要在开发者平台申请PMS商品。您的应用可通过调用 createProductOrderIntentWithPrice接口发起商品购买请求。

1. 点击**自定义商品购买**，需要设置商品ID、商品名称、商品类型、币种、价格、是否沙盒支付。

   ```
   注意：自定义商品购买暂不支持订阅型商品。
   ```

2. 如果不设置沙盒支付，显示微信、支付宝支付。

3. 如果设置沙盒支付，显示沙盒支付。

4. 点击**确认支付**，跳转相应的支付渠道，确认支付成功。

5. 点击**知道了**，返回到商品界面。如果购买的是消耗型商品，可以根据需求是否在客户端消耗。


### 取消订阅

订阅型商品购买之后，如果需要解约，您的应用客户端需要调用IAP SDK的cancelSubscriptionProduct接口去取消订阅。

点击**取消订阅**，显示是否取消成功。

### 查看用户历史购买记录

您可使用obtainOwnedPurchaseRecord接口查询用户已购买的商品列表。

点击**查看用户历史购买记录**，根据商品类型productType，可以查询用户所有已购买的商品列表。
